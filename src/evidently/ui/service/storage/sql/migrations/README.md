# Alembic Migrations for SQL Storage

This directory contains Alembic migration scripts for managing database schema changes in the SQL storage backend.

## Quick Start (Recommended)

The easiest way to run migrations is using the Evidently CLI:

```bash
# Upgrade to latest migration
evidently migrate postgresql://user:pass@localhost/evidently

# Check migration status
evidently migrate-status postgresql://user:pass@localhost/evidently

# Create new migration from model changes
evidently migrate postgresql://user:pass@localhost/evidently --autogenerate -m "add new column"

# Downgrade one revision
evidently migrate postgresql://user:pass@localhost/evidently --downgrade --revision -1
```

## Setup

Install the SQL extra (includes Alembic):
```bash
pip install evidently[sql]
```

## Usage

### Initialize Database Schema

Before creating migrations, ensure your database is initialized. You can create the initial schema using:

```python
from evidently.ui.service.storage.sql.models import Base
from sqlalchemy import create_engine

engine = create_engine("sqlite:///evidently.db")  # or your database URL
Base.metadata.create_all(engine)
```

### Using Evidently CLI (Recommended)

The `evidently migrate` command provides the easiest way to run migrations:

```bash
# Upgrade to latest
evidently migrate <database_url>

# Upgrade to specific revision
evidently migrate <database_url> --revision abc123

# Create new migration
evidently migrate <database_url> --autogenerate -m "description"

# Downgrade
evidently migrate <database_url> --downgrade --revision -1

# Check status
evidently migrate-status <database_url>
```

### Using Alembic Directly

If you prefer to use Alembic directly, navigate to the migrations directory:

```bash
cd src/evidently/ui/service/storage/sql/migrations
```

Then use standard Alembic commands:

```bash
# Create a new migration
alembic revision -m "description of migration"
alembic revision --autogenerate -m "description of migration"

# Apply migrations
alembic -x url="postgresql://user:pass@localhost/evidently" upgrade head
# Or set sqlalchemy.url in alembic.ini and run:
alembic upgrade head

# Rollback
alembic downgrade -1
alembic downgrade <revision>

# Check status
alembic current
alembic history
```

### Programmatic Usage

You can also run migrations from Python code:

```python
from evidently.ui.service.storage.sql import migrate_database

# Run migrations
migrate_database("postgresql://user:pass@localhost/evidently")
```

Or use the CLI function:

```python
from evidently.cli.migrate import run_migrations

run_migrations(
    database_url="postgresql://user:pass@localhost/evidently",
    revision="head",
    autogenerate=False,
    downgrade=False,
)
```

## Configuration

### Database URL Formats

- **SQLite**: `sqlite:///path/to/database.db`
- **PostgreSQL**: `postgresql://user:password@host:port/database`
- **MySQL**: `mysql://user:password@host:port/database`

### Options

- **CLI**: Pass database URL as argument to `evidently migrate`
- **Alembic**: Use `-x url=<database_url>` or set `sqlalchemy.url` in `alembic.ini`
- **Environment**: Set `EVIDENTLY_DATABASE_URL` (if supported by your setup)

## Models

All models are automatically imported in `env.py`. When adding new models:
1. Import them in `migrations/env.py`
2. Alembic will detect them automatically for autogenerate

## Notes

- Always review autogenerated migrations before applying them
- Test migrations on a development database first
- Keep migrations focused and atomic
- Never modify existing migration files once they've been applied to production
- The `evidently migrate` command handles all path and configuration setup automatically
